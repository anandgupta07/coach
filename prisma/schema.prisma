// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  name      String?
  phone     String?
  image     String?
  role      String   @default("user") // "user" or "coach"
  assessmentCompleted Boolean @default(false) // Track if pre-assessment is completed
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  subscriptions    UserSubscription[]
  workoutPlans     WorkoutPlan[]      @relation("ClientWorkouts")
  dietPlans        DietPlan[]         @relation("ClientDiets")
  createdWorkouts  WorkoutPlan[]      @relation("CoachWorkouts")
  createdDiets     DietPlan[]         @relation("CoachDiets")
  assessment       ClientAssessment?
  blogPosts        BlogPost[]
}

model SubscriptionPlan {
  id          Int      @id @default(autoincrement())
  name        String   // "Basic", "Pro", "Premium"
  description String?  @db.Text
  price       Decimal  @db.Decimal(10, 2)
  duration    Int      // Duration in days (30, 90, 365)
  features    String?  @db.Text // JSON string of features
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subscriptions UserSubscription[]
}

model UserSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  planId    Int
  status    String   @default("active") // "active", "expired", "cancelled"
  startDate DateTime @default(now())
  endDate   DateTime
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  plan SubscriptionPlan @relation(fields: [planId], references: [id])

  @@index([userId])
  @@index([planId])
}

model WorkoutPlan {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  clientId    Int
  coachId     Int
  weekNumber  Int      // Week number for tracking weekly plans
  startDate   DateTime
  endDate     DateTime
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  client    User       @relation("ClientWorkouts", fields: [clientId], references: [id], onDelete: Cascade)
  coach     User       @relation("CoachWorkouts", fields: [coachId], references: [id])
  exercises Exercise[]

  @@index([clientId])
  @@index([coachId])
}

model Exercise {
  id            Int      @id @default(autoincrement())
  workoutPlanId Int
  name          String
  description   String?  @db.Text
  sets          Int?
  reps          String?  // "10-12" or "15" etc
  duration      Int?     // Duration in minutes
  restTime      Int?     // Rest time in seconds
  videoUrl      String?
  day           String   // "Monday", "Tuesday", etc.
  order         Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Relations
  workoutPlan WorkoutPlan @relation(fields: [workoutPlanId], references: [id], onDelete: Cascade)

  @@index([workoutPlanId])
}

model DietPlan {
  id          Int      @id @default(autoincrement())
  title       String
  description String?  @db.Text
  clientId    Int
  coachId     Int
  weekNumber  Int      // Week number for tracking weekly plans
  startDate   DateTime
  endDate     DateTime
  targetCalories Int?
  notes       String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  client User   @relation("ClientDiets", fields: [clientId], references: [id], onDelete: Cascade)
  coach  User   @relation("CoachDiets", fields: [coachId], references: [id])
  meals  Meal[]

  @@index([clientId])
  @@index([coachId])
}

model Meal {
  id          Int      @id @default(autoincrement())
  dietPlanId  Int
  name        String
  description String?  @db.Text
  mealType    String   // "Breakfast", "Lunch", "Dinner", "Snack"
  calories    Int?
  protein     Decimal? @db.Decimal(10, 2)
  carbs       Decimal? @db.Decimal(10, 2)
  fats        Decimal? @db.Decimal(10, 2)
  ingredients String?  @db.Text
  instructions String? @db.Text
  day         String   // "Monday", "Tuesday", etc.
  time        String?  // "08:00 AM"
  order       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  dietPlan DietPlan @relation(fields: [dietPlanId], references: [id], onDelete: Cascade)

  @@index([dietPlanId])
}

model PromoCode {
  id                 Int      @id @default(autoincrement())
  code               String   @unique // Promo code (e.g., "SAVE20", "NEWYEAR50")
  discountType       String   // "percentage" or "fixed"
  discountValue      Decimal  @db.Decimal(10, 2) // 20 (for 20%) or 500 (for â‚¹500 off)
  maxUses            Int?     // Maximum number of times this code can be used (null = unlimited)
  currentUses        Int      @default(0) // Current number of times used
  minPurchaseAmount  Decimal? @db.Decimal(10, 2) // Minimum purchase amount required
  expiryDate         DateTime? // Expiry date (null = never expires)
  isActive           Boolean  @default(true)
  description        String?  @db.Text // Description of the promo code
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  @@index([code])
}

model ClientAssessment {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique

  // Personal Information
  dateOfBirth       DateTime?
  height            Decimal?  @db.Decimal(5, 2) // in cm
  weight            Decimal?  @db.Decimal(5, 2) // in kg
  fatPercentage     Decimal?  @db.Decimal(5, 2)
  address           String?   @db.Text
  emergencyContact  String?

  // PAR-Q Form (Yes/No questions)
  heartCondition    Boolean   @default(false)
  chestPainActivity Boolean   @default(false)
  chestPainRest     Boolean   @default(false)
  dizzinessBalance  Boolean   @default(false)
  boneJointProblem  Boolean   @default(false)
  pregnant          Boolean   @default(false)
  recentSurgery     Boolean   @default(false)
  takingMedication  Boolean   @default(false)
  medicationDetails String?   @db.Text

  // Lifestyle
  smoking           Boolean   @default(false)
  smokingAmount     String?
  alcohol           Boolean   @default(false)
  alcoholGlassesPerWeek Int?
  sleepHours        Int?
  jobType           String?   // "sedentary", "active", "physically-demanding"
  jobRequiresTravel Boolean   @default(false)
  stressLevel       Int?      // 1-10
  familyOverweight  String?   @db.Text // JSON array of family members
  overweightAsChild Boolean   @default(false)
  overweightAges    String?

  // Fitness History
  bestShapePeriod   String?   @db.Text
  exercisingConsistently Boolean @default(false)
  currentFitnessLevel Int?    // 1-10

  // Nutrition
  mealsPerDay       Int?
  skipMeals         Boolean   @default(false)
  eatBreakfast      Boolean   @default(true)
  eatLateNight      String?   // "sometimes", "often", "never"
  energyDrops       Boolean   @default(false)
  energyDropTime    String?
  takingSupplements Boolean   @default(false)
  supplementsList   String?   @db.Text
  mealLocation      String?   // "eat-outside", "bring-food"
  eatOutsidePerWeek Int?
  eatingReasons     String?   @db.Text // JSON array
  eatPastFullness   String?   // "often", "sometimes", "never"
  highSugarFoods    String?   // "often", "sometimes", "never"

  // Goals (can select multiple)
  goalLoseFat       Boolean   @default(false)
  goalRehabilitate  Boolean   @default(false)
  goalSportsTraining Boolean  @default(false)
  goalMuscleGain    Boolean   @default(false)
  goalOther         String?   @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model BlogPost {
  id          Int      @id @default(autoincrement())
  title       String
  slug        String   @unique
  content     String   @db.LongText
  excerpt     String?  @db.Text
  coverImage  String?
  videoUrl    String?  // YouTube video URL
  authorId    Int
  published   Boolean  @default(false)
  publishedAt DateTime?
  readTime    Int?     // Reading time in minutes
  views       Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)

  @@index([authorId])
  @@index([slug])
  @@index([publishedAt])
}

model Notification {
  id        Int      @id @default(autoincrement())
  coachId   Int      // Coach who created the notification
  message   String   @db.Text
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([coachId])
  @@index([isActive])
}

model PushSubscription {
  id           Int      @id @default(autoincrement())
  userId       Int
  endpoint     String   @db.Text
  endpointHash String   @db.VarChar(64) // Hash of endpoint for unique constraint
  p256dh       String   @db.Text
  auth         String   @db.Text
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([userId])
  @@unique([userId, endpointHash])
}

model ContactSubmission {
  id        Int      @id @default(autoincrement())
  name      String
  email     String
  phone     String?
  subject   String
  message   String   @db.Text
  status    String   @default("new") // "new", "read", "replied", "closed"
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([email])
  @@index([status])
  @@index([createdAt])
}
